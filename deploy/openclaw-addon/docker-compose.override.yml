# Place this file in the root of the official OpenClaw repo (next to docker-compose.yml)
# or use it with: docker compose -f docker-compose.yml -f /path/to/this/file ...
#
# It adds:
# - opencode server (containerized, using your local opencode binary packaged into image)
# - OpenAI-compatible bridge for OpenClaw custom provider
# - Feishu plugin env vars for OpenClaw gateway

services:
  openclaw-gateway:
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Feishu / Lark plugin (after installing @openclaw/feishu in gateway)
      FEISHU_APP_ID: ${FEISHU_APP_ID:-}
      FEISHU_APP_SECRET: ${FEISHU_APP_SECRET:-}
      FEISHU_VERIFICATION_TOKEN: ${FEISHU_VERIFICATION_TOKEN:-}
      FEISHU_ENCRYPT_KEY: ${FEISHU_ENCRYPT_KEY:-}
      HTTP_PROXY: ${HOST_HTTP_PROXY:-}
      HTTPS_PROXY: ${HOST_HTTPS_PROXY:-}
      NO_PROXY: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}
      http_proxy: ${HOST_HTTP_PROXY:-}
      https_proxy: ${HOST_HTTPS_PROXY:-}
      no_proxy: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}

  openclaw-cli:
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      FEISHU_APP_ID: ${FEISHU_APP_ID:-}
      FEISHU_APP_SECRET: ${FEISHU_APP_SECRET:-}
      FEISHU_VERIFICATION_TOKEN: ${FEISHU_VERIFICATION_TOKEN:-}
      FEISHU_ENCRYPT_KEY: ${FEISHU_ENCRYPT_KEY:-}
      HTTP_PROXY: ${HOST_HTTP_PROXY:-}
      HTTPS_PROXY: ${HOST_HTTPS_PROXY:-}
      NO_PROXY: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}
      http_proxy: ${HOST_HTTP_PROXY:-}
      https_proxy: ${HOST_HTTPS_PROXY:-}
      no_proxy: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}

  opencode:
    # Default: use prebuilt GHCR image.
    # For local binary build, run:
    #   OPENCODE_PULL_POLICY=never docker compose build opencode
    # and make sure docker/opencode/opencode exists.
    image: ${OPENCODE_IMAGE:-ghcr.io/alphabaijinde/openclaw-opencode:latest}
    pull_policy: ${OPENCODE_PULL_POLICY:-always}
    build:
      context: ./docker/opencode
      dockerfile: Dockerfile
      args:
        HTTP_PROXY: ${HOST_HTTP_PROXY:-}
        HTTPS_PROXY: ${HOST_HTTPS_PROXY:-}
        NO_PROXY: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}
    container_name: opencode
    restart: unless-stopped
    environment:
      # Official opencode docs: Basic auth enabled by default, username defaults to "opencode"
      OPENCODE_AUTH_PASSWORD: ${OPENCODE_AUTH_PASSWORD:?set_in_.env}
      OPENCODE_AUTH_USERNAME: ${OPENCODE_AUTH_USERNAME:-opencode}
      # Optional provider/model defaults for your opencode instance
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      HTTP_PROXY: ${HOST_HTTP_PROXY:-}
      HTTPS_PROXY: ${HOST_HTTPS_PROXY:-}
      NO_PROXY: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}
      http_proxy: ${HOST_HTTP_PROXY:-}
      https_proxy: ${HOST_HTTPS_PROXY:-}
      no_proxy: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}
    volumes:
      # Optional: reuse host opencode install/plugins (recommended if your "free AI" path depends on local plugins)
      - ${OPENCODE_INSTALL_DIR:-./opencode-home}:/root/.opencode:ro
      # Persist opencode state/config inside the OpenClaw repo folder
      - ./opencode-data/config:/root/.config/opencode
      - ./opencode-data/share:/root/.local/share/opencode
      # Optional workdir that opencode can access (adjust to your needs)
      - ./:/workspace
    command: ["serve", "--hostname", "0.0.0.0", "--port", "4096"]
    networks:
      - default

  opencode-bridge:
    # Default: use prebuilt GHCR image.
    # For local source build, keep OPENCODE_BRIDGE_CONTEXT and run `docker compose build opencode-bridge`.
    image: ${OPENCODE_BRIDGE_IMAGE:-ghcr.io/alphabaijinde/openclaw-opencode-bridge:latest}
    pull_policy: ${OPENCODE_BRIDGE_PULL_POLICY:-always}
    build:
      context: ${OPENCODE_BRIDGE_CONTEXT:-./opencode-bridge}
      dockerfile: Dockerfile
      args:
        HTTP_PROXY: ${HOST_HTTP_PROXY:-}
        HTTPS_PROXY: ${HOST_HTTPS_PROXY:-}
        NO_PROXY: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}
    container_name: opencode-bridge
    restart: unless-stopped
    environment:
      HOST: 0.0.0.0
      PORT: 8787
      BRIDGE_API_KEY: ${OPENCODE_BRIDGE_API_KEY:?set_in_.env}
      OPENAI_MODEL_ID: ${OPENCODE_OPENAI_MODEL_ID:-opencode-local}
      OPENCODE_BASE_URL: http://opencode:4096
      OPENCODE_AUTH_MODE: basic
      OPENCODE_AUTH_USERNAME: ${OPENCODE_AUTH_USERNAME:-opencode}
      OPENCODE_AUTH_PASSWORD: ${OPENCODE_AUTH_PASSWORD:?set_in_.env}
      OPENCODE_DIRECTORY: ${OPENCODE_DIRECTORY:-/workspace}
      OPENCODE_PROVIDER_ID: ${OPENCODE_PROVIDER_ID:-}
      OPENCODE_MODEL_ID: ${OPENCODE_MODEL_ID:-}
      OPENCODE_AGENT: ${OPENCODE_AGENT:-}
      OPENCODE_SYSTEM: ${OPENCODE_SYSTEM:-}
      MODEL_MAP_JSON: ${OPENCODE_MODEL_MAP_JSON:-}
      HTTP_PROXY: ${HOST_HTTP_PROXY:-}
      HTTPS_PROXY: ${HOST_HTTPS_PROXY:-}
      NO_PROXY: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}
      http_proxy: ${HOST_HTTP_PROXY:-}
      https_proxy: ${HOST_HTTPS_PROXY:-}
      no_proxy: ${HOST_NO_PROXY:-localhost,127.0.0.1,opencode,opencode-bridge,host.docker.internal}
    depends_on:
      - opencode
    ports:
      - "${OPENCODE_BRIDGE_PORT:-8787}:8787"
    networks:
      - default
